# tdd-rules

## 基本原則

- TDD の目的はテスト数を増やすことではなく、設計を改善しながら安全に変更できる状態を保つことに置く。
- 変更は常に小さく刻み、1 サイクルで扱う関心事を 1 つに絞る。
- テストは振る舞いを表現し、実装詳細への過剰な依存を避ける。
- Red で失敗理由を明確にし、Green で最小実装を選び、Refactor で重複と複雑さを減らす。

## Test List ルール

- Test List は「利用者が観測できる振る舞い」を単位に作る。
- 各項目は 1 サイクルで終えられる粒度に分割する。
- 優先順位は「リスクが高い順」「仕様の核に近い順」で決める。
- 未着手、進行中、完了を明示し、同時に進行中は 1 件だけにする。

## Red ルール

- 先にテストを書く。
- テスト名で失敗させたい振る舞いを明示する。
- 失敗理由は 1 つに限定する。
- テストが失敗しない場合は、テストか前提条件を見直してから進む。

## Green ルール

- 失敗を通すための最小実装だけを加える。
- 将来の拡張を先回りして実装しない。
- 新しい失敗を増やした場合は、直前の Red に戻る。

## Refactor ルール

- Green の後に必ず Refactor を行う。
- 振る舞いを変えない変更だけを行う。
- 命名改善、重複除去、責務分離を優先する。
- Refactor 後は直前に通したテスト群を再実行する。

## 不具合修正ルール

- 先に最小再現テストを追加する。
- 再現テストが Red になることを確認する。
- 修正は再現テストを Green にする最小変更から始める。
- 回帰防止のため、関連テストも再実行する。
- 不具合修正が完了した場合は、再現テストを `Done Criteria` の対象に含める。

## 停止判定の分類

- `recoverable`: 復旧手順を提示すれば再開できる停止。
- `needs-confirmation`: ユーザー確認がないと再開できない停止。

## 停止判定ルール

- 失敗テストなしで実装する要求が来た場合は `recoverable` とし、最小失敗テストの追加案を提示する。
- 対象外の既存失敗を分離できない場合は `recoverable` とし、対象テスト切り出し案を提示する。
- 1 サイクルで複数の振る舞いを同時に変える必要がある場合は `recoverable` とし、Test List 再分割案を提示する。
- テストコマンド候補がすべて失敗し、追加情報が不足している場合は `needs-confirmation` とし、1 回だけ確認質問を行う。

## 停止時の必須出力

- `Trigger`: 停止条件。
- `Class`: `recoverable|needs-confirmation`。
- `Signal`: 停止を検知した事実。
- `Recovery`: 再開に必要な手順。
- `Next One Step`: 直近で実行する 1 手。

## DoD 接続ルール

- 各サイクル終了時に `Done Criteria` を更新する。
- `Done Criteria` が未達なら `Exit Check` は必ず `FAIL` にする。
- `Exit Check` を `PASS` にするには、対象テストと回帰確認の両方を満たす。
